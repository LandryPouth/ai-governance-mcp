#!/bin/bash

# Git hook pre-push pour AI Governance
# V√©rifications finales avant push vers remote

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# D√©tecte le mode
if [ -f ".ai-governance.json" ]; then
    MODE=$(grep -o '"mode"[[:space:]]*:[[:space:]]*"[^"]*"' .ai-governance.json | cut -d'"' -f4)
else
    MODE="standard"
fi

echo -e "${BLUE}üîç V√©rification pre-push (mode: $MODE)${NC}"

# R√©cup√®re les infos du push
remote="$1"
url="$2"

# D√©tecte la branche actuelle
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "  ‚Üí Branche: $CURRENT_BRANCH"
echo "  ‚Üí Remote: $remote"

# ==================================================================
# R√àGLES MODE LIGHT
# ==================================================================

if [[ "$MODE" == "light" ]]; then
    # En mode light, on laisse passer
    echo -e "${GREEN}‚úÖ Push autoris√© (mode light)${NC}"
    exit 0
fi

# ==================================================================
# R√àGLES MODE STANDARD
# ==================================================================

if [[ "$MODE" == "standard" ]]; then
    
    # Avertissement si push direct sur main/develop
    if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "master" ]] || [[ "$CURRENT_BRANCH" == "develop" ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Tu es sur la branche $CURRENT_BRANCH${NC}"
        echo ""
        echo "En mode STANDARD, il est recommand√© de:"
        echo "  1. Cr√©er une branche feature/fix"
        echo "  2. Push cette branche"
        echo "  3. Faire une Pull Request"
        echo ""
        read -p "Continuer le push sur $CURRENT_BRANCH ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Push annul√©."
            exit 1
        fi
    fi
    
    # V√©rifie que les tests passent
    if [ -f "package.json" ] && grep -q "\"test\":" package.json; then
        echo "  ‚Üí Ex√©cution des tests avant push..."
        if ! npm test > /dev/null 2>&1; then
            echo -e "${YELLOW}‚ö†Ô∏è  Des tests √©chouent${NC}"
            read -p "Pusher quand m√™me ? (y/N) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 1
            fi
        fi
    fi
    
    echo -e "${GREEN}‚úÖ Push autoris√©${NC}"
    exit 0
fi

# ==================================================================
# R√àGLES MODE STRICT
# ==================================================================

if [[ "$MODE" == "strict" ]]; then
    
    # INTERDIT de push direct sur main/master/develop
    if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "master" ]] || [[ "$CURRENT_BRANCH" == "develop" ]]; then
        echo -e "${RED}‚ùå PUSH REFUS√â${NC}"
        echo ""
        echo "En mode STRICT, le push direct sur $CURRENT_BRANCH est INTERDIT."
        echo ""
        echo "Workflow obligatoire:"
        echo "  1. Cr√©e une branche:"
        echo "     git checkout -b feature/TICKET-123-description"
        echo ""
        echo "  2. Push la branche:"
        echo "     git push origin feature/TICKET-123-description"
        echo ""
        echo "  3. Cr√©e une Pull Request sur GitHub/GitLab"
        echo ""
        echo "  4. Merge via la PR (apr√®s review)"
        echo ""
        echo "Exception: Si tu es vraiment s√ªr (hotfix urgent), utilise:"
        echo "  git push --no-verify"
        exit 1
    fi
    
    # V√©rifie le format du nom de branche
    BRANCH_PATTERN="^(feature|fix|refactor|hotfix|release)/[A-Z]+-[0-9]+-[a-z0-9-]+$"
    if ! echo "$CURRENT_BRANCH" | grep -qE "$BRANCH_PATTERN"; then
        echo -e "${YELLOW}‚ö†Ô∏è  Format de branche non conventionnel${NC}"
        echo ""
        echo "Format attendu:"
        echo "  feature/TICKET-123-description"
        echo "  fix/BUG-456-correction"
        echo "  refactor/TECH-789-amelioration"
        echo ""
        echo "Ta branche: $CURRENT_BRANCH"
        echo ""
        read -p "Continuer quand m√™me ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo ""
            echo "Renomme ta branche:"
            echo "  git branch -m nouvelle-branche"
            exit 1
        fi
    fi
    
    # OBLIGATOIRE : tests doivent passer
    echo "  ‚Üí Ex√©cution des tests (obligatoire en mode strict)..."
    if [ -f "package.json" ] && grep -q "\"test\":" package.json; then
        if ! npm test; then
            echo -e "${RED}‚ùå PUSH REFUS√â - Tests √©chouent${NC}"
            echo ""
            echo "En mode STRICT, tous les tests doivent passer avant un push."
            echo "Corrige les tests ou utilise --no-verify (d√©conseill√©)."
            exit 1
        fi
    fi
    
    # OBLIGATOIRE : lint doit passer
    echo "  ‚Üí V√©rification du lint (obligatoire en mode strict)..."
    if [ -f "package.json" ] && grep -q "\"lint\":" package.json; then
        if ! npm run lint; then
            echo -e "${RED}‚ùå PUSH REFUS√â - Erreurs de lint${NC}"
            echo ""
            echo "Corrige les erreurs avec:"
            echo "  npm run lint --fix"
            exit 1
        fi
    fi
    
    # OBLIGATOIRE : build doit r√©ussir
    echo "  ‚Üí V√©rification du build (obligatoire en mode strict)..."
    if [ -f "package.json" ] && grep -q "\"build\":" package.json; then
        if ! npm run build > /dev/null 2>&1; then
            echo -e "${RED}‚ùå PUSH REFUS√â - Build √©choue${NC}"
            echo ""
            echo "Le build doit r√©ussir avant un push."
            echo "Lance 'npm run build' pour voir les erreurs."
            exit 1
        fi
    fi
    
    # V√©rifie qu'il n'y a pas de fichiers volumineux
    echo "  ‚Üí V√©rification des fichiers volumineux..."
    MAX_SIZE=500000  # 500KB
    LARGE_FILES=$(git diff --stat --cached origin/"$CURRENT_BRANCH" 2>/dev/null | grep -E "^\s+.+\|\s+[0-9]+" | while read line; do
        file=$(echo "$line" | awk '{print $1}')
        if [ -f "$file" ]; then
            size=$(wc -c < "$file" 2>/dev/null || echo 0)
            if [ "$size" -gt $MAX_SIZE ]; then
                echo "$file ($((size / 1024))KB)"
            fi
        fi
    done)
    
    if [ -n "$LARGE_FILES" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Fichiers volumineux d√©tect√©s:${NC}"
        echo "$LARGE_FILES"
        echo ""
        echo "Consid√®re utiliser Git LFS pour les gros fichiers."
        read -p "Continuer quand m√™me ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
    
    echo -e "${GREEN}‚úÖ Toutes les v√©rifications sont pass√©es${NC}"
    echo -e "${GREEN}‚úÖ Push autoris√©${NC}"
    exit 0
fi

exit 0