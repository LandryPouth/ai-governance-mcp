#!/bin/bash

# Git hook commit-msg pour AI Governance
# V√©rifie le format du message de commit selon le mode

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# D√©tecte le mode
if [ -f ".ai-governance.json" ]; then
    MODE=$(grep -o '"mode"[[:space:]]*:[[:space:]]*"[^"]*"' .ai-governance.json | cut -d'"' -f4)
else
    MODE="standard"
fi

# Lit le message de commit
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Ignore les commits de merge et revert
if echo "$COMMIT_MSG" | grep -qE "^(Merge|Revert)"; then
    exit 0
fi

echo "üîç V√©rification du message de commit (mode: $MODE)"

# ==================================================================
# MODE LIGHT - V√©rifications minimales
# ==================================================================

if [[ "$MODE" == "light" ]]; then
    # Juste v√©rifier qu'il y a un message
    if [ ${#COMMIT_MSG} -lt 10 ]; then
        echo -e "${RED}‚ùå Message de commit trop court${NC}"
        echo "Minimum 10 caract√®res requis."
        exit 1
    fi
    
    echo -e "${GREEN}‚úÖ Message de commit OK${NC}"
    exit 0
fi

# ==================================================================
# MODE STANDARD - Format conventionnel recommand√©
# ==================================================================

if [[ "$MODE" == "standard" ]]; then
    # Format recommand√© : type(scope): description
    # Exemples: feat(auth): ajoute login OAuth
    #           fix(api): corrige validation email
    
    CONVENTIONAL_PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf)(\([a-z0-9-]+\))?: .{10,}"
    
    if ! echo "$COMMIT_MSG" | grep -qE "$CONVENTIONAL_PATTERN"; then
        echo -e "${YELLOW}‚ö†Ô∏è  Format de commit non conventionnel${NC}"
        echo ""
        echo "Format recommand√© (Conventional Commits):"
        echo "  type(scope): description"
        echo ""
        echo "Types valides:"
        echo "  feat     - nouvelle fonctionnalit√©"
        echo "  fix      - correction de bug"
        echo "  docs     - documentation"
        echo "  style    - formatage, points-virgules manquants, etc."
        echo "  refactor - refactoring du code"
        echo "  test     - ajout de tests"
        echo "  chore    - maintenance, d√©pendances"
        echo "  perf     - am√©lioration de performance"
        echo ""
        echo "Exemples:"
        echo "  feat(auth): ajoute login OAuth"
        echo "  fix(api): corrige validation email"
        echo "  docs(readme): met √† jour les instructions"
        echo ""
        
        read -p "Continuer quand m√™me ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Commit annul√©. Modifie ton message avec:"
            echo "  git commit --amend"
            exit 1
        fi
    fi
    
    echo -e "${GREEN}‚úÖ Message de commit OK${NC}"
    exit 0
fi

# ==================================================================
# MODE STRICT - Format conventionnel OBLIGATOIRE
# ==================================================================

if [[ "$MODE" == "strict" ]]; then
    # En mode strict, le format est obligatoire
    CONVENTIONAL_PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|build|ci)(\([a-z0-9-]+\))?: .{10,}"
    
    if ! echo "$COMMIT_MSG" | grep -qE "$CONVENTIONAL_PATTERN"; then
        echo -e "${RED}‚ùå COMMIT REFUS√â - Format invalide${NC}"
        echo ""
        echo "En mode STRICT, le format Conventional Commits est OBLIGATOIRE:"
        echo "  type(scope): description"
        echo ""
        echo "Types valides:"
        echo "  feat     - nouvelle fonctionnalit√©"
        echo "  fix      - correction de bug"
        echo "  docs     - documentation"
        echo "  style    - formatage"
        echo "  refactor - refactoring"
        echo "  test     - tests"
        echo "  chore    - maintenance"
        echo "  perf     - performance"
        echo "  build    - syst√®me de build"
        echo "  ci       - int√©gration continue"
        echo ""
        echo "Le scope est optionnel mais recommand√©."
        echo "La description doit faire au moins 10 caract√®res."
        echo ""
        echo "Exemples valides:"
        echo "  feat(auth): ajoute connexion Google OAuth"
        echo "  fix(api): corrige validation des emails"
        echo "  refactor(db): migre vers Prisma ORM"
        echo ""
        echo "Modifie ton message avec:"
        echo "  git commit --amend"
        exit 1
    fi
    
    # V√©rification suppl√©mentaire : pas de WIP en mode strict
    if echo "$COMMIT_MSG" | grep -iqE "^(wip|tmp|test|debug)"; then
        echo -e "${RED}‚ùå COMMIT REFUS√â - Message non professionnel${NC}"
        echo ""
        echo "En mode STRICT, les messages de type WIP/TMP/TEST sont interdits."
        echo "Utilise un format conventionnel descriptif."
        exit 1
    fi
    
    # V√©rification : le message ne doit pas √™tre trop long (premi√®re ligne)
    FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)
    if [ ${#FIRST_LINE} -gt 72 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Premi√®re ligne trop longue (${#FIRST_LINE} caract√®res)${NC}"
        echo "Recommandation: maximum 72 caract√®res"
        echo ""
        read -p "Continuer quand m√™me ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
    
    echo -e "${GREEN}‚úÖ Message de commit valid√©${NC}"
    exit 0
fi

exit 0