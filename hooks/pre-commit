#!/bin/bash

# Git hook pre-commit pour AI Governance
# V√©rifie que les r√®gles de gouvernance sont respect√©es avant un commit

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# D√©tecte le mode de gouvernance
if [ -f ".ai-governance.json" ]; then
    MODE=$(grep -o '"mode"[[:space:]]*:[[:space:]]*"[^"]*"' .ai-governance.json | cut -d'"' -f4)
else
    MODE="standard"
fi

echo -e "${BLUE}üîç V√©rification pre-commit (mode: $MODE)${NC}"

# ==================================================================
# R√àGLES COMMUNES √Ä TOUS LES MODES
# ==================================================================

# V√©rification : pas de secrets
echo "  ‚Üí V√©rification des secrets..."
SECRET_PATTERNS=(
    "sk_live_"
    "sk_test_" 
    "api_key[[:space:]]*=[[:space:]]*['\"][^'\"]{20,}"
    "password[[:space:]]*=[[:space:]]*['\"][^'\"]+['\"]"
    "secret[[:space:]]*=[[:space:]]*['\"][^'\"]+['\"]"
    "token[[:space:]]*=[[:space:]]*['\"][^'\"]{20,}"
)

SECRETS_FOUND=0
for pattern in "${SECRET_PATTERNS[@]}"; do
    if git diff --cached | grep -iE "$pattern" > /dev/null; then
        echo -e "${RED}‚ùå Secret potentiel d√©tect√©: $pattern${NC}"
        SECRETS_FOUND=1
    fi
done

if [ $SECRETS_FOUND -eq 1 ]; then
    echo -e "${RED}‚ùå COMMIT REFUS√â - Secrets d√©tect√©s${NC}"
    echo ""
    echo "Solutions:"
    echo "  1. Utilise des variables d'environnement"
    echo "  2. Ajoute au .gitignore"
    echo "  3. Utilise un .env (non commit√©)"
    exit 1
fi

# ==================================================================
# R√àGLES MODE STANDARD ET STRICT
# ==================================================================

if [[ "$MODE" == "standard" ]] || [[ "$MODE" == "strict" ]]; then
    
    # V√©rification : format du message de commit (sera v√©rifi√© dans commit-msg)
    echo "  ‚Üí V√©rification du format de commit..."
    
    # V√©rification : tests passent (si configur√©)
    if [ -f "package.json" ]; then
        if grep -q "\"test\":" package.json; then
            echo "  ‚Üí Ex√©cution des tests..."
            
            # En mode strict, tous les tests doivent passer
            if [[ "$MODE" == "strict" ]]; then
                if ! npm test > /dev/null 2>&1; then
                    echo -e "${RED}‚ùå COMMIT REFUS√â - Tests √©chouent${NC}"
                    echo ""
                    echo "En mode STRICT, tous les tests doivent passer."
                    echo "Lance 'npm test' pour voir les erreurs."
                    exit 1
                fi
            fi
        fi
    fi
    
    # V√©rification : lint (si configur√©)
    if [ -f "package.json" ]; then
        if grep -q "\"lint\":" package.json; then
            echo "  ‚Üí V√©rification du lint..."
            
            if [[ "$MODE" == "strict" ]]; then
                if ! npm run lint > /dev/null 2>&1; then
                    echo -e "${YELLOW}‚ö†Ô∏è  Avertissement - Erreurs de lint d√©tect√©es${NC}"
                    echo "Lance 'npm run lint' pour corriger."
                    
                    # En mode strict, on bloque
                    echo -e "${RED}‚ùå COMMIT REFUS√â en mode STRICT${NC}"
                    exit 1
                fi
            fi
        fi
    fi
fi

# ==================================================================
# R√àGLES MODE STRICT UNIQUEMENT
# ==================================================================

if [[ "$MODE" == "strict" ]]; then
    
    # V√©rification : pas de console.log/debug
    echo "  ‚Üí V√©rification des console.log..."
    if git diff --cached | grep -E "console\.(log|debug|info)" > /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  console.log d√©tect√©s dans le code${NC}"
        echo ""
        read -p "Continuer quand m√™me ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
    
    # V√©rification : pas de TODO/FIXME dans le code commit√©
    echo "  ‚Üí V√©rification des TODO/FIXME..."
    if git diff --cached | grep -E "(TODO|FIXME|XXX)" > /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  TODO/FIXME d√©tect√©s${NC}"
        echo ""
        echo "En mode STRICT, les TODO doivent √™tre dans des issues, pas dans le code."
        read -p "Continuer quand m√™me ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
    
    # V√©rification : fichiers trop gros
    echo "  ‚Üí V√©rification de la taille des fichiers..."
    MAX_SIZE=1000000  # 1MB
    LARGE_FILES=$(git diff --cached --name-only | while read file; do
        if [ -f "$file" ]; then
            size=$(wc -c < "$file")
            if [ $size -gt $MAX_SIZE ]; then
                echo "$file ($((size / 1024))KB)"
            fi
        fi
    done)
    
    if [ -n "$LARGE_FILES" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Fichiers volumineux d√©tect√©s:${NC}"
        echo "$LARGE_FILES"
        echo ""
        read -p "Continuer quand m√™me ? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

echo -e "${GREEN}‚úÖ V√©rifications pre-commit pass√©es${NC}"
exit 0